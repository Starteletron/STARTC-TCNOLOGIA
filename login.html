<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entrar • StarC Tecnologias</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b1220; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#22c55e; --brand-700:#16a34a; --border:#1f2937; --input:#0f172a; --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif; background:var(--bg); color:var(--text); display:grid; place-items:center; padding:20px;}
  .wrap{width:100%; max-width:960px; display:grid; grid-template-columns:1.2fr 1fr; gap:26px}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .hero{background:linear-gradient(145deg,#0b1220,#0a0f1a); border:1px solid var(--border); border-radius:var(--radius); padding:32px}
  .hero h1{font-size:clamp(24px,4vw,36px); margin:0 0 8px}
  .hero p{color:var(--muted); margin:0 0 20px}
  .card{background:linear-gradient(180deg,#0e1626,#0a0f1a); border:1px solid var(--border); border-radius:var(--radius); padding:28px}
  .title{font-size:22px; margin:0 0 6px}
  .muted{color:var(--muted); font-size:14px; margin:0 0 18px}
  .field{display:grid; gap:8px; margin:12px 0}
  label{font-size:14px; color:#cbd5e1}
  input{width:100%; background:var(--input); border:1px solid var(--border); color:var(--text);
        padding:12px 14px; border-radius:10px; outline:none}
  input:focus{border-color:#334155; box-shadow:0 0 0 3px rgba(51,65,85,.25)}
  .btn{width:100%; background:var(--brand); color:#06250f; border:1px solid #1a2e22; font-weight:700;
       padding:12px 16px; border-radius:12px; cursor:pointer}
  .btn-ghost{width:100%; margin-top:10px; background:#0f172a; color:#cbd5e1; border:1px solid var(--border)}
  .row{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0}
  .link{color:#93c5fd; text-decoration:none; font-size:13px}
  .link:hover{text-decoration:underline}
  .err,.ok{margin-top:12px; padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid}
  .err{color:#fecaca; background:#2a0f14; border-color:#7f1d1d}
  .ok{color:#bbf7d0; background:#0f2a19; border-color:#14532d}
</style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <h1>Acesso exclusivo às ferramentas e automações</h1>
      <p>Entre para usar o NEYBOT, análises fiscais, fluxos financeiros inteligentes, rotinas com IA e cobranças recorrentes.</p>
      <ul style="margin:0; padding-left:18px; color:#cbd5e1; line-height:1.7">
        <li>Assinantes com status <b>Ativo</b></li>
        <li>Controle de acesso por <b>role</b> (user/admin)</li>
        <li>Login por e-mail/senha e Google</li>
      </ul>
    </section>

    <section class="card">
      <h2 class="title">Entrar</h2>
      <p class="muted">Use seu e-mail e senha. Para convite/acesso, fale com o suporte.</p>

      <form id="formLogin">
        <div class="field">
          <label for="email">E-mail</label>
          <input id="email" type="email" placeholder="voce@empresa.com" autocomplete="username" required />
        </div>
        <div class="field">
          <label for="senha">Senha</label>
          <input id="senha" type="password" placeholder="••••••••" autocomplete="current-password" required />
        </div>
        <div class="row">
          <a class="link" id="forgot" href="#">Esqueci minha senha</a>
          <a class="link" href="contato.html">Precisa de acesso?</a>
        </div>
        <button class="btn" type="submit" id="btnLogin">Entrar</button>
        <div id="msg" style="min-height:14px"></div>
        <div style="height:10px"></div>
        <button class="btn-ghost" type="button" id="btnGoogle">Entrar com Google</button>
      </form>
    </section>
  </div>

<script>
  // ===== CONFIGURE AQUI =====
  const SUPABASE_URL = "https://SEU-PROJECT.supabase.co";
  const SUPABASE_ANON = "SEU-ANON-KEY";
  const REDIRECT_AFTER_LOGIN = "ferramentas.html";
  // ==========================

  const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON);

  const $ = sel => document.querySelector(sel);
  const msg = $("#msg");
  const btnLogin = $("#btnLogin");

  function setMsg(text, type='err'){
    msg.className = (type==='ok')?'ok':'err';
    msg.textContent = text || '';
  }

  // Verifica se já está logado
  (async ()=>{
    const { data: { session } } = await supabase.auth.getSession();
    if(session){
      // opcional: checar status/role antes de redirecionar
      const ok = await checkAccess(session);
      if(ok) location.href = REDIRECT_AFTER_LOGIN;
    }
  })();

  // Checa no profiles se o usuário está Ativo
  async function checkAccess(session){
    const user = session?.user;
    if(!user) return false;
    const { data, error } = await supabase
      .from('profiles')
      .select('status, role, name')
      .eq('id', user.id)
      .single();
    if(error){ setMsg('Erro ao verificar acesso.'); return false; }
    if(data?.status !== 'Ativo'){ setMsg('Usuário inativo.'); return false; }
    // guarda dados no localStorage (opcional)
    localStorage.setItem('stc_user', JSON.stringify({
      email: user.email, name: data?.name || '', role: data?.role || 'user'
    }));
    return true;
  }

  // Login com e-mail/senha
  $("#formLogin").addEventListener("submit", async (ev)=>{
    ev.preventDefault(); setMsg('');
    const email = $("#email").value.trim().toLowerCase();
    const senha = $("#senha").value;

    if(!email || !senha){ setMsg('Informe e-mail e senha.'); return; }

    btnLogin.disabled = true; btnLogin.textContent = "Entrando…";
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });
    btnLogin.disabled = false; btnLogin.textContent = "Entrar";

    if(error){ setMsg(error.message || 'Falha no login.'); return; }

    const ok = await checkAccess(data.session);
    if(ok){ location.href = REDIRECT_AFTER_LOGIN; }
  });

  // Reset de senha (e-mail com link)
  $("#forgot").addEventListener("click", async (e)=>{
    e.preventDefault(); setMsg('');
    const email = $("#email").value.trim().toLowerCase();
    if(!email){ setMsg('Digite seu e-mail no campo acima para receber o link.'); return; }
    const redirectTo = location.origin + location.pathname.replace('login.html','login.html'); // volta para a mesma página
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if(error){ setMsg(error.message); return; }
    setMsg('Enviamos um link de redefinição para seu e-mail.', 'ok');
  });

  // Login com Google
  $("#btnGoogle").addEventListener("click", async ()=>{
    setMsg('');
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.origin + window.location.pathname }
    });
    if(error){ setMsg(error.message); }
    // redireciona para Google; depois retorna aqui autenticado
  });

  // Quando voltar do link de reset, Supabase pede a nova senha:
  (async ()=>{
    const { data: { session } } = await supabase.auth.getSession();
    const hash = window.location.hash || '';
    if (hash.includes('type=recovery')) {
      const nova = prompt('Digite sua nova senha:');
      if(!nova) return;
      const { data, error } = await supabase.auth.updateUser({ password: nova });
      if(error){ setMsg(error.message); return; }
      setMsg('Senha alterada. Você já pode entrar.', 'ok');
    }
  })();
</script>
</body>
</html>
